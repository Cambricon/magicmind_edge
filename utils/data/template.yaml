image: yellow.hub.cambricon.com/magicmind/release/x86_64/magicmind:0.13.0-x86_64-ubuntu18.04-py_3_7

variables:
  GIT_DEPTH: "1"

report-result:
    stage: .post
    tags: 
        - edge_zoo_no_chip_28_concurrency
    script:
        - python utils/merge_table.py
        - python utils/check_result.py benchmark.csv benchmark_ok.csv
    artifacts:
        paths:
            - ${CI_PROJECT_DIR}/benchmark.csv

.network_test:
    stage: test
    variables:
        REMOTE_DIR: ${CI_PROJECT_DIR}
        HOST_IP: ${HOST_IP}
    tags: 
        - edge_zoo_no_chip_28_concurrency
    timeout: 10 hours
    retry: 2
    script:
        # request edge divice
        - python ${CI_PROJECT_DIR}/utils/ci/get_edge_device.py
        - source ${CI_PROJECT_DIR}/ci_env.sh
        - export REMOTE_DIR=${CI_PROJECT_DIR}
        # mount nfs
        - sshpass -e  ssh -o "StrictHostKeyChecking=no" root@${REMOTE_IP} mkdir -p /mount_data
        - sshpass -e  ssh -o "StrictHostKeyChecking=no" root@${REMOTE_IP} 'mount | grep /mount_data || if [ "$?" == 1 ]; then mount -o nolock '${HOST_IP}':/home/cambricon/ci/modelzoo_edge /mount_data; fi'
        # load model cache
        - cd ${TEST_PROJ_DIR}
        - mkdir -p data/models
        - cp -r /mount_data/models_cache/${TEST_PROJ_DIR##*/}/* data/models
        # start test
        - if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
        - source env.sh
        - ./run.sh

    artifacts:
        paths:
            - ${TEST_PROJ_DIR}/benchmark/benchmark.csv
